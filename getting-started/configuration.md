# Конфигурация

## Вступление

Все файлы конфигурации для фреймворка Laravel хранятся в каталоге `config`. Каждый вариант документирован, так что не стесняйтесь просматривать файлы и знакомиться с доступными вам опциями.

Эти файлы конфигурации позволяют вам настраивать такие вещи, как информация о подключении к базе данных, информация о почтовом сервере, а также различные другие основные значения конфигурации, такие как часовой пояс вашего приложения и ключ шифрования.

## Конфигурация окружения <a id="env-config"></a>

Часто бывает полезно иметь различные значения конфигурации в зависимости от среды, в которой запущено приложение. Например, вы можете воспользоваться другим драйвером кэша на локальном сервере, нежели на вашем производственном сервере.

Чтобы сделать это возможным, Laravel использует PHP-библиотеку [DotEnv](https://github.com/vlucas/phpdotenv). В свежей установке Laravel корневая директория вашего приложения будет содержать файл `.env.example`, который определяет множество общих переменных окружения. В процессе установки Laravel этот файл будет автоматически скопирован в `.env`.

Файл `.env` по умолчанию содержит некоторые общие значения конфигурации, которые могут отличаться в зависимости от того, запущено ли ваше приложение локально или на производственном веб-сервере. Эти значения затем извлекаются из различных конфигурационных файлов Laravel в каталоге `config` с помощью функции-помощника `env`.

Если вы разрабатываете в команде, то вы, возможно, захотите продолжить включать в ваше приложение файл с примером `.env.example`. Поместив значения переменных окружения в пример конфигурационного файла, другие разработчики в вашей команде смогут четко увидеть, какие переменные окружения необходимы для запуска вашего приложения.

{% hint style="info" %}
Любая переменная в вашем `.env`-файле может быть переопределена внешними переменными окружения, такими как переменные окружения на уровне сервера или системы.
{% endhint %}

#### Безопасность env файла

Ваш файл `.env` должен быть исключен из системы контроля версий, так как для каждого разработчика/сервера, использующего ваше приложение, может потребоваться своя конфигурация среды. Более того, это будет представлять собой риск для безопасности в случае, если злоумышленник получит доступ к вашему репозиторию, так как любые конфиденциальные учетные данные будут раскрыты.

### Типы переменных окружения

Все переменные в ваших `.env`-файлах всегда интерпретируются как строки, поэтому некоторые зарезервированные значения были созданы, чтобы позволить вам вернуть более широкий диапазон типов из функции `env()`:

| `.env` Значение | `env()` Значение |
| :--- | :--- |
| `true` | `(bool) true` |
| `(true)` | `(bool) true` |
| `false` | `(bool) false` |
| `(false)` | `(bool) false` |
| `empty` | `(string) ''` |
| `(empty)` | `(string) ''` |
| `null` | `(null) null` |
| `(null)` | `(null) null` |

Если вам нужно определить переменную окружения со значением, содержащим пробелы, вы можете сделать это, заключив значение в двойные кавычки:

```php
APP_NAME="My Application"
```

### Получение конфигурации окружения

Все переменные, перечисленные в этом файле, будут загружены в супер-глобальную PHP переменную `$_ENV`. Тем не менее, вы можете использовать помощник `env` для получения значений из этих переменных в ваших конфигурационных файлах. Фактически, если вы просмотрите конфигурационные файлы Laravel, вы заметите, что многие из вариантов уже используют этот помощник:

```php
'debug' => env('APP_DEBUG', false),
```

Второе значение, переданное в функцию `env`, является "значением по умолчанию". Это значение будет возвращено, если для данного ключа не существует переменной окружения.

### Определение текущего окружения

Текущее окружение приложения определяется с помощью переменной `APP_ENV` из вашего `.env` файла. Доступ к этому значению можно получить методом `environment` фасада `App`:

```php
use Illuminate\Support\Facades\App;

$environment = App::environment();
```

Вы также можете передать аргументы в метод `environment`, чтобы определить, соответствует ли окружение заданному значению. Метод вернет `true`, если окружение соответствует любому из заданных значений:

```php
if (App::environment('local')) {
    // The environment is local
}

if (App::environment(['local', 'staging'])) {
    // The environment is either local OR staging...
}
```

{% hint style="info" %}
Определение текущей среды приложений может быть переопределено путем определения переменной окружения `APP_ENV` на уровне сервера.
{% endhint %}

## Доступ к значениям конфигурации

Вы можете легко получить доступ к своим значениям конфигурации с помощью функции помощника `config` из любой точки вашего приложения. Доступ к значениям конфигурации можно получить, используя синтаксис "точка", который включает в себя имя файла и опцию, к которой вы хотите получить доступ. Значение по умолчанию также может быть указано и будет возвращено, если опция конфигурации не существует:

```php
$value = config('app.timezone');

// Получить значение по умолчанию, если значение конфигурации не существует....
$value = config('app.timezone', 'Asia/Seoul');
```

Чтобы установить значения конфигурации во время выполнения, передайте массив в помощник `config`:

```php
config(['app.timezone' => 'America/Chicago']);
```

## Кэширование конфигурации

Для ускорения работы приложения необходимо кэшировать все конфигурационные файлы в один файл с помощью Artisan-команды `config:cache`. Это позволит объединить все параметры конфигурации вашего приложения в один файл, который может быть быстро загружен фреймворком.

Обычно вы должны запустить команду `php artisan config:cache` как часть процесса деплоя. Команду не следует запускать во время локальной разработки, так как опции конфигурации часто нужно будет менять в процессе разработки вашего приложения.

{% hint style="danger" %}
Если вы выполняете команду `config:cache` при деплое, вы должны быть уверены, что вызываете функцию `env` только из своих конфигурационных файлов. После того, как конфигурация будет кэширована, `.env` файл не будет загружаться, и все обращения к функции `env` вернут `null`.
{% endhint %}

## Режим отладки

Опция `debug` в конфигурационном файле `config/app.php` определяет, какая информация об ошибке отображается пользователю. По умолчанию эта опция установлена с учетом значения переменной окружения `APP_DEBUG`, которая хранится в вашем `.env` файле.

Для локальной разработки необходимо установить переменную окружения `APP_DEBUG` в `true`. **В вашем производственном окружении это значение всегда должно быть `false`. Если переменная установлена в `true` в производственном окружении, вы рискуете подвергнуть конечных пользователей вашего приложения воздействию чувствительных значений конфигурации.**

## Режим обслуживания

Когда ваше приложение находится в режиме обслуживания, для всех запросов в приложение будет отображаться пользовательский вид. Это позволяет легко "отключить" ваше приложение во время его обновления или при выполнении обслуживания. Проверка режима обслуживания включена в стандартный стек посредников. Если приложение находится в режиме обслуживания, будет брошено сообщение `MaintenanceModeException` с кодом состояния 503.o enable maintenance mode, execute the `down` Artisan command:

```bash
php artisan down
```

Вы также можете указать опцию `retry` \(повторить попытку\) для команды `down`, которая будет установлена в качестве значения заголовка Retry-After HTTP:

```bash
php artisan down --retry=60
```

### Обход режима обслуживания

Даже находясь в режиме обслуживания, вы можете использовать опцию `secret`, чтобы указать токен обхода режима обслуживания:

```bash
php artisan down --secret="1630542a-246b-4b66-afa1-dd72a4c43515"
```

После перевода приложения в режим обслуживания вы можете перейти к URL-адресу приложения, соответствующему этой метке, и Laravel выдаст в вашем браузере куки-файл для обхода режима обслуживания:

```text
https://example.com/1630542a-246b-4b66-afa1-dd72a4c43515
```

При доступе к этому скрытому маршруту вы будете перенаправлены на `/` маршрут. После того, как cookie-файл будет выдан вашему браузеру, вы сможете просматривать приложение в обычном режиме, как если бы оно не находилось в режиме обслуживания.

### Пререндер страницы режима обслуживания

Если вы используете команду `php artisan down` во время деплоя, ваши пользователи все еще могут иногда сталкиваться с ошибками, если они получают доступ к приложению во время обновления зависимостей Composer или других компонентов инфраструктуры. Это происходит потому, что значительная часть инфраструктуры Laravel должна загрузиться, чтобы определить, что ваше приложение находится в режиме обслуживания и отобразить вид режима обслуживания с помощью шаблонизатора.

По этой причине Laravel позволяет предварительно запросить вид режима обслуживания, который будет возвращен в самом начале цикла запроса. Этот вид отображается до того, как будет загружена какая-либо из зависимостей вашего приложения. Вы можете предварительно отрисовать шаблон по вашему выбору, используя опцию `render` команды `down`:

```bash
php artisan down --render="errors::503"
```

### Перенаправления в режиме обслуживания

Находясь в режиме обслуживания, Laravel будет отображать вид режима обслуживания для всех URL-адресов приложений, к которым пользователь пытается получить доступ. При желании вы можете поручить Laravel перенаправить все запросы на определенный URL. Это может быть выполнено с помощью опции `redirect`. Например, вы можете перенаправить все запросы на URI `/`:

```bash
php artisan down --redirect=/
```

### **Отключение режима обслуживания**

Чтобы отключить режим обслуживания, используйте команду `up`:

```bash
php artisan up
```

{% hint style="info" %}
Вы можете настроить шаблон режима обслуживания по умолчанию, определив свой собственный шаблон в файле `resource/views/errrors/503.blade.php`.
{% endhint %}

### **Режим обслуживания и очереди**

Пока ваше приложение находится в режиме обслуживания, не будут обрабатываться задания, стоящие в [очереди](../queues.md). Задания начнут обрабатываться в обычном режиме, как только приложение выйдет из режима обслуживания.

### **Альтернативы режима обслуживания**

Поскольку режим обслуживания требует от вашего приложения нескольких секунд простоя, рассмотрите альтернативные варианты, такие как [Laravel Vapor](https://vapor.laravel.com/) и [Envoyer](https://envoyer.io/), для достижения нулевого простоя развертывания с Laravel.

